#!/usr/bin/env bash

source etc/banner
# Banner Add
echo -e "executing: ${LIGHTGREEN} Pubg-paster${NOCOLOR}"
echo "-----------------------"

# Set the trial period duration in seconds (2 minutes = 120 seconds)
TRIAL_DURATION=120
# Set the trial password
TRIAL_PASSWORD="1234"

# File to store the start time
START_TIME_FILE="/tmp/pubg_paster_start_time"

# Check if the start time file exists
if [[ ! -f "$START_TIME_FILE" ]]; then
    # Record the start time
    date +%s > "$START_TIME_FILE"
fi

# Read the start time
start_time=$(cat "$START_TIME_FILE")
current_time=$(date +%s)
elapsed_time=$((current_time - start_time))

# Check if the trial period has expired
if (( elapsed_time > TRIAL_DURATION )); then
    # Prompt the user for the password
    read -p "Enter the trial password: " input_password
    echo

    # Validate the password
    if [[ "$input_password" != "$TRIAL_PASSWORD" ]]; then
        echo "Invalid password."
        exit 1
    fi
fi

OUTPUT_DIR="/storage/emulated/0/PUBGPASTER/output"
INPUT_DIR="/storage/emulated/0/PUBGPASTER/INPUT"

# Create directories if they don't exist
if [[ ! -d "$OUTPUT_DIR" ]]; then
    mkdir -p "$OUTPUT_DIR"
fi

if [[ ! -d "$INPUT_DIR" ]]; then
    mkdir -p "$INPUT_DIR"
fi

# Function to unpack files
unpacking () {
  if qemu-i386 $PREFIX/share/quickbms/quickbms -9 -Q etc/tools.bms "$opt" "$OUTPUT_DIR"; then
    echo "Unpacking successful!"
  else
    echo "Unpacking failed! Please check the file and try again."
  fi
}

# Function to repack files
repacking () {
  if qemu-i386 $PREFIX/share/quickbms/quickbms -9 -w -r -r etc/tools.bms "$opt" "$OUTPUT_DIR"; then
    echo "Repacking successful!"
  else
    echo "Repacking failed! Please check the file and try again."
  fi
}

# Function to search within the output directory
search_in_output () {
  read -p "Enter the text to search for: " search_text
  grep -R "$search_text" "$OUTPUT_DIR"
}

# Function to handle unpacking process
function unpack {
  prompt="Please select a file to unpack:"
  options=( $(find "$INPUT_DIR" -name "*.pak") )

  PS3="$prompt "
  select opt in "${options[@]}" "Quit"; do 
    if (( REPLY == 1 + ${#options[@]} )); then
        exit
    elif (( REPLY > 0 && REPLY <= ${#options[@]} )); then
        echo "You picked $opt which is file $REPLY"
        unpacking
        break
    else
        echo "Invalid option. Try another one."
    fi
  done
}

# Function to handle repacking process
function repack {
  prompt="Please select a file to repack:"
  options=( $(find "$INPUT_DIR" -name "*.pak") )

  PS3="$prompt "
  select opt in "${options[@]}" "Quit"; do 
    if (( REPLY == 1 + ${#options[@]} )); then
        exit
    elif (( REPLY > 0 && REPLY <= ${#options[@]} )); then
        echo "You picked $opt which is file $REPLY"
        repacking
        break
    else
        echo "Invalid option. Try another one."
    fi
  done
}

# Main menu
PS3='Please enter your choice: '
options=("Unpack" "Repack" "Search in Output" "Quit")
select opt in "${options[@]}"; do
    case $opt in
        "Unpack")
            unpack
            break
            ;;
        "Repack")
            repack
            ;;
        "Search in Output")
            search_in_output
            ;;
        "Quit")
            break
            ;;
        *) echo "Invalid option $REPLY";;
    esac
done
