#!/usr/bin/env bash

# Colors Definition
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
LIGHTGREEN='\033[0;92m'
PURPLE='\033[0;35m'
ORANGE='\033[38;5;208m' # Orange
PINK='\033[38;5;213m' # Pink
NOCOLOR='\033[0m' # No Color

# Banner Add
echo -e "${GREEN}Executing: ${PURPLE}Pubg-paster${NOCOLOR}"
echo "-----------------------"

# Function to check installation ID (assuming this function is defined elsewhere)
check_installation_id() {
    # Placeholder for the actual implementation
    echo "Checking installation ID..."
}

# Function to check expiration and ask for password extension
check_expiration() {
    # Placeholder for the actual implementation
    echo "Checking expiration..."
}

# Call the function to check installation ID
check_installation_id

# Call the function to check expiration
check_expiration

# Directories
OUTPUT_DIR="/storage/emulated/0/PUBGPASTER/output"
INPUT_DIR="/storage/emulated/0/PUBGPASTER/INPUT"
TEMP_OUTPUT_DIR="/storage/emulated/0/PUBGPASTER/ADD_MODDED_FILES"

# Ensure directories exist
for DIR in "$OUTPUT_DIR" "$INPUT_DIR" "$TEMP_OUTPUT_DIR"; do
    [[ ! -d "$DIR" ]] && mkdir -p "$DIR"
done

# Unpacking function
unpacking() {
    if qemu-i386 "$PREFIX/share/quickbms/quickbms" -9 -Q etc/tools.bms "$opt" "$OUTPUT_DIR"; then
        echo -e "${GREEN}Unpacking successful!${NOCOLOR}"
    else
        echo -e "${RED}Unpacking failed!${NOCOLOR}"
    fi
}

# Repacking function
repacking() {
    if qemu-i386 "$PREFIX/share/quickbms/quickbms" -9 -w -r -r etc/tools.bms "$opt" "$TEMP_OUTPUT_DIR"; then
        echo -e "${GREEN}Repacking successful!${NOCOLOR}"
    else
        echo -e "${RED}Repacking failed!${NOCOLOR}"
    fi
}

# Unpack Menu
unpack() {
    prompt="Please select a file to unpack:"
    options=( $(find "$INPUT_DIR" -name "*.pak") )

    echo -e "${BLUE}-----------------------------------------------${NOCOLOR}"
    echo -e "${PINK}# ${prompt}${NOCOLOR}"
    echo -e "${BLUE}-----------------------------------------------${LIGHTGREEN}"

    options+=("Back to Menu")

    PS3=$(echo -e "${PINK}Select a file:${LIGHTGREEN} ")
    select opt in "${options[@]}"; do 
        if [[ "$opt" == "Back to Menu" ]]; then
            echo -e "${RED}Returning to main menu...${NOCOLOR}"
            main_menu
            break
        elif [[ " ${options[@]} " =~ " ${opt} " ]]; then
            echo -e "${ORANGE}You picked $opt.${NOCOLOR}"
            unpacking
            main_menu  # Return to main menu after unpacking
            break
        else
            echo -e "${RED}Invalid option. Try another one.${NOCOLOR}"
        fi
    done
}

# Repack Menu
repack() {
    prompt="Please select a file to repack:"
    options=( $(find "$INPUT_DIR" -name "*.pak") )

    echo -e "${BLUE}-----------------------------------------------${NOCOLOR}"
    echo -e "${PINK}# ${prompt}${NOCOLOR}"
    echo -e "${BLUE}-----------------------------------------------${YELLOW}"

    options+=("Back to Menu")

    PS3=$(echo -e "${PINK}Select a file:${YELLOW} ")
    select opt in "${options[@]}"; do 
        if [[ "$opt" == "Back to Menu" ]]; then
            echo -e "${RED}Returning to main menu...${NOCOLOR}"
            main_menu
            break
        elif [[ " ${options[@]} " =~ " ${opt} " ]]; then
            echo -e "${ORANGE}You picked $opt.${NOCOLOR}"
            repacking
            main_menu  # Return to main menu after repacking
            break
        else
            echo -e "${RED}Invalid option. Try another one.${NOCOLOR}"
        fi
    done
}

# Main Menu Function
main_menu() {
    echo -e "${BLUE}--------------------------------------------${NOCOLOR}" 
    echo -e "${PINK}# Please enter your choice:${NOCOLOR}"  
    echo -e "${BLUE}--------------------------------------------${NOCOLOR}" 
    echo -e "${GREEN}# 1. Unpack${NOCOLOR}"  
    echo -e "${YELLOW}# 2. Repack${NOCOLOR}"  
    echo -e "${BLUE}--------------------------------------------${NOCOLOR}" 
    echo -e "${RED}# 3. Quit${NOCOLOR}" 
    echo -e "${BLUE}--------------------------------------------${RED}" 

    read -p "Enter your choice [1-3]: " choice  

    case $choice in
        1)
            unpack  
            ;;
        2)
            repack  
            ;;
        3)
            echo -e "${GREEN}Exiting...${NOCOLOR}"  
            exit 0
            ;;
        *)
            echo -e "${PINK}Invalid choice. Please enter a number between 1 and 3.${NOCOLOR}"
            sleep 2  
            main_menu  
            ;;
    esac
}

# Start the script
main_menu
