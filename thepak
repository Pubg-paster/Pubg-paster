#!/usr/bin/env bash

# Define the correct password
correct_password="DRAJ"

# Prompt the user for the password
echo -n "Enter password: "
read -s entered_password
echo

# Verify the password
if [[ "$entered_password" != "$correct_password" ]]; then
    echo "Incorrect password. Exiting..."
    exit 1
fi

source etc/banner
# Banner Add
echo -e "executing: ${LIGHTGREEN} Pubg-paster"
echo "-----------------------"

PUBG_PASTER_DIR="/storage/emulated/0/PUBG-PASTER"
OUTPUT_DIR="$PUBG_PASTER_DIR/output"
INPUT_DIR="$PUBG_PASTER_DIR/INPUTpak"

# Create directories if they don't exist
mkdir -p "$PUBG_PASTER_DIR" "$OUTPUT_DIR" "$INPUT_DIR"

log_file="$OUTPUT_DIR/operation.log"

unpacking () {
  qemu-i386 $PREFIX/share/quickbms/quickbms -Q etc/tools.bms "$1" "$OUTPUT_DIR" >> "$log_file" 2>&1
  if [[ $? -ne 0 ]]; then
    echo "Error unpacking $1" | tee -a "$log_file"
  else
    echo "Successfully unpacked $1" | tee -a "$log_file"
  fi
}

repacking () {
  qemu-i386 $PREFIX/share/quickbms/quickbms -w -r -r etc/tools.bms "$1" "$OUTPUT_DIR" >> "$log_file" 2>&1
  if [[ $? -ne 0 ]]; then
    echo "Error repacking $1" | tee -a "$log_file"
  else
    echo "Successfully repacked $1" | tee -a "$log_file"
  fi
}

function unpack {
    prompt="Please select a file to unpack:"
    options=( $(find "$INPUT_DIR" -name "*.pak") )

    PS3="$prompt "
    select opt in "${options[@]}" "Quit"; do
        if (( REPLY == 1 + ${#options[@]} )); then
            exit
        elif (( REPLY > 0 && REPLY <= ${#options[@]} )); then
            echo "You picked $opt which is file $REPLY"
            unpacking "$opt"
            break
        else
            echo "Invalid option. Try another one."
        fi
    done
}

function repack {
    prompt="Please select a file to repack:"
    options=( $(find "$INPUT_DIR" -name "*.pak") )

    PS3="$prompt "
    select opt in "${options[@]}" "Quit"; do
        if (( REPLY == 1 + ${#options[@]} )); then
            exit
        elif (( REPLY > 0 && REPLY <= ${#options[@]} )); then
            echo "You picked $opt which is file $REPLY"
            repacking "$opt"
            break
        else
            echo "Invalid option. Try another one."
        fi
    done
}

function search_text {
    echo -n "Enter text to search: "
    read search_text
    grep -R "$search_text" "$OUTPUT_DIR"
}

PS3='Please enter your choice: '
options=("Unpack" "Repack" "Search Text" "Quit")
select opt in "${options[@]}"
do
    case $opt in
        "Unpack")
            unpack
            ;;
        "Repack")
            repack
            ;;
        "Search Text")
            search_text
            ;;
        "Quit")
            break
            ;;
        *) echo "invalid option $REPLY";;
    esac
done
