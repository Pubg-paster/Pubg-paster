#!/usr/bin/env bash

source etc/banner
# Banner Add
echo -e "executing: ${LIGHTGREEN} Pubg-paster${NOCOLOR}"
echo "-----------------------"

OUTPUT_DIR="/storage/emulated/0/PUBGPASTER/output"
INPUT_DIR="/storage/emulated/0/PUBGPASTER/INPUT"

# Create directories if they don't exist
if [[ ! -d "$OUTPUT_DIR" ]]; then
    mkdir -p "$OUTPUT_DIR"
fi

if [[ ! -d "$INPUT_DIR" ]]; then
    mkdir -p "$INPUT_DIR"
fi

# Password protection
PASSWORD="1234"
while true; do
    read -p "Enter password to unlock the script: " input_password
    echo
    if [[ "$input_password" == "$PASSWORD" ]]; then
        break
    else
        echo "Incorrect password. Try again."
    fi
done

# Timer-based access control (3 minutes)
TIMER=180
(sleep $TIMER && kill $$) &

# Logging function
log_action() {
    local LOG_DIR="/storage/emulated/0/PUBGPASTER/logs"
    mkdir -p "$LOG_DIR"
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_DIR/script.log"
}

# Error handling function
handle_error() {
    echo "An error occurred: $1"
    log_action "Error: $1"
    exit 1
}

# Validate input function
validate_input() {
    if [[ -z "$1" ]]; then
        handle_error "Input cannot be empty. Please provide a valid input."
    fi
}

# Progress indicator function
show_progress() {
    while :; do
        for s in / - \\ \|; do
            printf "\r$s"
            sleep 0.1
        done
    done
}

# Function to unpack files
unpacking() {
    show_progress &
    PROGRESS_PID=$!
    if qemu-i386 $PREFIX/share/quickbms/quickbms -9 -Q etc/tools.bms "$opt" "$OUTPUT_DIR"; then
        kill $PROGRESS_PID
        echo "Unpacking successful!"
        log_action "Unpacking successful for $opt"
    else
        kill $PROGRESS_PID
        handle_error "Unpacking failed for $opt"
    fi
}

# Function to repack files
repacking() {
    show_progress &
    PROGRESS_PID=$!
    if qemu-i386 $PREFIX/share/quickbms/quickbms -9 -w -r -r etc/tools.bms "$opt" "$OUTPUT_DIR"; then
        kill $PROGRESS_PID
        echo "Repacking successful!"
        log_action "Repacking successful for $opt"
    else
        kill $PROGRESS_PID
        handle_error "Repacking failed for $opt"
    fi
}

# Function to search in output
TEXTsearch() {
    read -p "Enter the text to search for: " search_text
    validate_input "$search_text"
    grep -R "$search_text" "$OUTPUT_DIR"
    log_action "Search performed for text: $search_text"
}

# Function to clean up temporary files
cleanup() {
    rm -rf "$OUTPUT_DIR/tmp"
    echo "Temporary files cleaned up."
    log_action "Temporary files cleaned up."
}

# Function to unpack files interactively
function unpack {
    prompt="Please select a file to unpack:"
    options=( $(find "$INPUT_DIR" -name "*.pak") )

    PS3="$prompt "
    select opt in "${options[@]}" "Quit"; do 
        if (( REPLY == 1 + ${#options[@]} )); then
            exit
        elif (( REPLY > 0 && REPLY <= ${#options[@]} )); then
            echo "You picked $opt which is file $REPLY"
            unpacking
            break
        else
            echo "Invalid option. Try another one."
        fi
    done
}

# Function to repack files interactively
function repack {
    prompt="Please select a file to repack:"
    options=( $(find "$INPUT_DIR" -name "*.pak") )

    PS3="$prompt "
    select opt in "${options[@]}" "Quit"; do 
        if (( REPLY == 1 + ${#options[@]} )); then
            exit
        elif (( REPLY > 0 && REPLY <= ${#options[@]} )); then
            echo "You picked $opt which is file $REPLY"
            repacking
            break
        else
            echo "Invalid option. Try another one."
        fi
    done
}

# Main menu
PS3="Please select an option: "
options=("Unpack files" "Repack files" "Search text in output" "Clean up temporary files" "Quit")
select opt in "${options[@]}"; do
    case $opt in
        "Unpack files")
            unpack
            ;;
        "Repack files")
            repack
            ;;
        "Search text in output")
            TEXTsearch
            ;;
        "Clean up temporary files")
            cleanup
            ;;
        "Quit")
            break
            ;;
        *) echo "Invalid option. Try another one." ;;
    esac
done
